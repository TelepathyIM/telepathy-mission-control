#!/bin/sh

cd "@abs_top_builddir@/test/twisted/tools"

ulimit -c unlimited
exec > missioncontrol-$$.log 2>&1

if test -z "$MC_ACCOUNT_DIR"; then
        echo "MC_ACCOUNT_DIR must be set"
        exit 1
fi

if test -n "$MISSIONCONTROL_TEST_VALGRIND"; then
        G_DEBUG="$G_DEBUG,gc-friendly"
        export G_DEBUG
        G_SLICE=always-malloc
        export G_SLICE
	MISSIONCONTROL_WRAPPER="valgrind --leak-check=full --num-callers=20"
	MISSIONCONTROL_WRAPPER="$MISSIONCONTROL_WRAPPER --track-origins=yes"
	MISSIONCONTROL_WRAPPER="$MISSIONCONTROL_WRAPPER -v"
	MISSIONCONTROL_WRAPPER="$MISSIONCONTROL_WRAPPER --suppressions=@abs_top_srcdir@/test/twisted/tools/valgrind.supp"
	MISSIONCONTROL_WRAPPER="$MISSIONCONTROL_WRAPPER --gen-suppressions=all"
	MISSIONCONTROL_WRAPPER="$MISSIONCONTROL_WRAPPER --show-reachable=yes"
elif test -n "$MISSIONCONTROL_TEST_REFDBG"; then
        if test -z "$REFDBG_OPTIONS" ; then
                REFDBG_OPTIONS="btnum=10"
                export REFDBG_OPTIONS
        fi
        if test -z "$MISSIONCONTROL_WRAPPER" ; then
                MISSIONCONTROL_WRAPPER="refdbg"
        fi
fi

exec @abs_top_builddir@/libtool --mode=execute \
        $MISSIONCONTROL_WRAPPER \
        @abs_top_builddir@/test/twisted/mc-debug-server
